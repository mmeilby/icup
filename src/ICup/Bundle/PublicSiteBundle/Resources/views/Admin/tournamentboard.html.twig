{% extends "ICupPublicSiteBundle:Masters:edit.html.twig" %}

{% trans_default_domain "admin" %}

{% block adminbody %}
    <div ng-app="tournamentBoardModule">
        <div ng-controller="tournamentBoardController as ctrl">
            <section layout="column">
                <md-content flex>
                    <md-content flex>
                        <md-toolbar class="md-menu-toolbar">
                            <div layout="row">
                                <md-toolbar-filler layout layout-align="center center" style="background-color: #8c8c8c; color: white">
                                    <span class="fa fa-4x fa-cogs"></span>
                                </md-toolbar-filler>
                                <div ng-cloak>
                                    <h2 class="md-toolbar-tools">{{ 'FORM.TOURNAMENTBOARD.TITLE'|trans|upper }}</h2>
                                    <md-menu-bar>
                                        <md-menu>
                                            <button ng-click="$mdOpenMenu()">
                                                {% trans %}FORM.TOURNAMENTBOARD.PLANNING.CAPTION{% endtrans %}
                                            </button>
                                            <md-menu-content>
                                                <md-menu-item>
                                                    <md-button ng-href="{{ path('_edit_category_list', { 'tournamentid': tournament.id }) }}">
                                                        {% trans %}FORM.TOURNAMENTBOARD.LISTCATEGORIES.CAPTION{% endtrans %}
                                                        {#
                                                        <a class="list-group-item" href="{{ path('_edit_category_list', { 'tournamentid': tournament.id }) }}">
                                                            <h3 class="list-group-item-heading">{% trans %}FORM.TOURNAMENTBOARD.LISTCATEGORIES.CAPTION{% endtrans %}</h3>
                                                            <p class="list-group-item-text">{% trans %}FORM.TOURNAMENTBOARD.LISTCATEGORIES.DESCRIPTION{% endtrans %}</p>
                                                        </a>
                                                        #}
                                                    </md-button>
                                                </md-menu-item>
                                                <md-menu-item>
                                                    <md-button ng-href="{{ path('_edit_site_list', { 'tournamentid': tournament.id }) }}">
                                                        {% trans %}FORM.TOURNAMENTBOARD.LISTSITES.CAPTION{% endtrans %}
                                                        {#
                                                        <a class="list-group-item" href="{{ path('_edit_site_list', { 'tournamentid': tournament.id }) }}">
                                                            <h3 class="list-group-item-heading">{% trans %}FORM.TOURNAMENTBOARD.LISTSITES.CAPTION{% endtrans %}</h3>
                                                            <p class="list-group-item-text">{% trans %}FORM.TOURNAMENTBOARD.LISTSITES.DESCRIPTION{% endtrans %}</p>
                                                        </a>
                                                        #}
                                                    </md-button>
                                                </md-menu-item>
                                {% if is_granted('ROLE_EDITOR_ADMIN') %}
                                                <md-menu-divider></md-menu-divider>
                                                <md-menu-item>
                                                    <md-button ng-href="{{ path('_admin_wipe_matches', { 'tournamentid': tournament.id }) }}">
                                                        {% trans %}FORM.LISTCATEGORIES.BUTTON.WIPE{% endtrans %}
                                                    </md-button>
                                                </md-menu-item>
                                                <md-menu-item>
                                                    <md-button ng-href="{{ path('_admin_wipe_qmatches', { 'tournamentid': tournament.id }) }}">
                                                        {% trans %}FORM.LISTCATEGORIES.BUTTON.QWIPE{% endtrans %}
                                                    </md-button>
                                                </md-menu-item>
                                {% endif %}
                                            </md-menu-content>
                                        </md-menu>
                                    </md-menu-bar>
{#
                                                    <md-menu>
                                                        <md-button aria-label="Open demo menu" ng-click="$mdOpenMenu($event)">
                                                        </md-button>
                                                        <md-menu-content width="6">
                                                            <md-menu-item ng-repeat="item in [1, 2, 3]">
                                                                <md-button ng-click="ctrl.announceClick($index)">
                                                                    <md-icon md-menu-align-target md-svg-icon="call:no-sim"></md-icon>
                                                                    Option {{ '{{item}}' }}
                                                                </md-button>
                                                            </md-menu-item>
                                                        </md-menu-content>
                                                    </md-menu>
#}
                                </div>
                            </div>
                        </md-toolbar>
                    </md-content>

                    <md-content flex>
                        <md-tabs md-dynamic-height md-border-bottom>
                            {#
                                ---------------------
                                TOURNAMENT
                                ---------------------
                            #}
                            <md-tab label="{% trans %}FORM.TOURNAMENTBOARD.TOURNAMENT.CAPTION{% endtrans %}">
                                <md-content class="md-padding">
                                    <div class="page">
                                        <h2>{{ tournament.name }}</h2>
                                        <table class="table table-striped">
                                            <thead>
                                            <tr>
                                                <td>{% trans %}FORM.DASHBOARD.TOURNAMENTS.LEGEND.KEY{% endtrans %}</td>
                                                <td>{% trans %}FORM.DASHBOARD.TOURNAMENTS.LEGEND.EDITION{% endtrans %}</td>
                                                <td>{% trans %}FORM.DASHBOARD.TOURNAMENTS.LEGEND.DESCRIPTION{% endtrans %}</td>
                                                <td>{% trans %}FORM.DASHBOARD.TOURNAMENTS.LEGEND.STATUS{% endtrans %}</td>
                                                <td class="narrow-col"></td>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr>
                                                <td>
                                                    <b>{{ tournament.key }}</b>
                                                </td>
                                                <td>
                                                    {{ tournament.edition }}
                                                </td>
                                                <td>
                                                    {{ tournament.description }}
                                                </td>
                                                <td>
                                                    {{ ['FORM.DASHBOARD.TOURNAMENTS.STATUS.',tstat]|join|trans }}
                                                </td>
                                                <td>
                                                    <a href="{{ path('_edit_tournament_chg', { 'tournamentid': tournament.id }) }}">
                                                        <span class="fa fa-pencil"></span>
                                                    </a>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <md-list layout="row">
                                        <md-list-item>
                                            <md-button ng-href="{{ path('_edit_tournament_options', { 'tournamentid': tournament.id }) }}" aria-label="{% trans %}FORM.TOURNAMENTBOARD.TOURNAMENTOPTIONS.CAPTION{% endtrans %}">
                                                <span class="md-padding fa fa-2x fa-cog"></span><br />
                                                {% trans %}FORM.TOURNAMENTBOARD.TOURNAMENTOPTIONS.LABEL{% endtrans %}
                                            </md-button>
                                        </md-list-item>
                                        <md-list-item>
                                            <md-button ng-href="{{ path('_edit_timeslot_list', { 'tournamentid': tournament.id }) }}" aria-label="{% trans %}FORM.TOURNAMENTBOARD.LISTTIMESLOTS.CAPTION{% endtrans %}">
                                                <span class="md-padding fa fa-2x fa-clock-o"></span><br />
                                                {% trans %}FORM.TOURNAMENTBOARD.LISTTIMESLOTS.LABEL{% endtrans %}
                                            </md-button>
                                        </md-list-item>
                                        <md-list-item>
                                            <md-button ng-href="{{ path('_edit_news_list', { 'tournamentid': tournament.id }) }}" aria-label="{% trans %}FORM.TOURNAMENTBOARD.NEWS.CAPTION{% endtrans %}">
                                                <span class="md-padding fa fa-2x fa-newspaper-o"></span><br />
                                                {% trans %}FORM.TOURNAMENTBOARD.NEWS.LABEL{% endtrans %}
                                            </md-button>
                                        </md-list-item>
                                        <md-list-item>
                                            <md-button ng-href="{{ path('_edit_event_list', { 'tournamentid': tournament.id }) }}" aria-label="{% trans %}FORM.TOURNAMENTBOARD.STATUS.CAPTION{% endtrans %}">
                                                <span class="md-padding fa fa-2x fa-calendar"></span><br />
                                                {% trans %}FORM.TOURNAMENTBOARD.STATUS.LABEL{% endtrans %}
                                            </md-button>
                                        </md-list-item>
                                        <md-list-item>
                                            <md-button ng-href="{{ path('_edit_import_match_unres', { 'tournamentid': tournament.id }) }}" aria-label="{% trans %}FORM.TOURNAMENTBOARD.MATCHIMPORTUNRES.CAPTION{% endtrans %}">
                                                <span class="md-padding fa fa-2x fa-trophy"></span><br />
                                                {% trans %}FORM.TOURNAMENTBOARD.MATCHIMPORTUNRES.LABEL{% endtrans %}
                                            </md-button>
                                        </md-list-item>
                                        <md-list-item>
                                            <md-button ng-href="{{ path('_edit_list_matches', { 'tournamentid': tournament.id }) }}" aria-label="{% trans %}FORM.TOURNAMENTBOARD.REPORT.CAPTION{% endtrans %}">
                                                <span class="md-padding fa fa-2x fa-book"></span><br />
                                                {% trans %}FORM.TOURNAMENTBOARD.REPORT.LABEL{% endtrans %}
                                            </md-button>
                                        </md-list-item>
                                        <md-list-item>
                                            <md-button ng-href="{{ path('_edit_matchlist_print', { 'tournamentid': tournament.id, 'date': date()|date('d-m-Y') }) }}" aria-label="{% trans %}FORM.TOURNAMENTBOARD.MATCHPRINT.CAPTION{% endtrans %}">
                                                <span class="md-padding fa fa-2x fa-print"></span><br />
                                                {% trans %}FORM.TOURNAMENTBOARD.MATCHPRINT.LABEL{% endtrans %}
                                            </md-button>
                                        </md-list-item>
                                        <md-list-item>
                                            <md-button ng-href="{{ path('_edit_match_maint', { 'tournamentid': tournament.id }) }}" aria-label="{% trans %}FORM.TOURNAMENTBOARD.MATCHMAINT.CAPTION{% endtrans %}">
                                                <span class="md-padding fa fa-2x fa-pencil-square-o"></span><br />
                                                {% trans %}FORM.TOURNAMENTBOARD.MATCHMAINT.LABEL{% endtrans %}
                                            </md-button>
                                        </md-list-item>
<!--
                                        <md-list-item>
                                            <md-button href="http://google.com"
                                                       title="Launch Google.com in new window"
                                                       target="_blank"
                                                       ng-disabled="true"
                                                       aria-label="Google.com"
                                                       class="md-accent" >
                                                <span class="md-padding fa fa-2x fa-bars"></span><br />
                                                Launch
                                            </md-button>
                                        </md-list-item>
-->
                                    </md-list>
                                </md-content>
                            </md-tab>
                            {#
                                ---------------------
                                CATEGORIES
                                ---------------------
                            #}
                            <md-tab label="{% trans %}FORM.TOURNAMENTBOARD.LISTCATEGORIES.CAPTION{% endtrans %}">
                                <md-content class="md-padding" ng-controller="assignGroupsController" ng-cloak>
                                    <div class="row md-padding">
                                        <div class="col-md-4 col-sm-6">
                                            <md-button class="md-raised md-hue-1" ng-class="{'md-primary': categories.length==0}" ng-click="addCategory($event)" ng-hide="!dataReady">
                                                {% trans %}FORM.TOURNAMENTBOARD.ADDCATEGORY{% endtrans %}
                                            </md-button>
                                        </div>
                                        <div class="col-md-8 col-sm-6">
                                            <md-button class="md-raised md-hue-1" ng-class="{'md-primary': groups.length==0}" ng-click="addGroup($event)" ng-hide="!selectedCategory || !dataReady">
                                                {% trans %}FORM.QMATCHPLANNING.ADDGROUP{% endtrans %}
                                            </md-button>
                                            <md-button class="md-raised md-hue-1" ng-click="categoryOptions($event)" ng-hide="!selectedCategory || !dataReady">
                                                {% trans %}FORM.QMATCHPLANNING.OPTIONS{% endtrans %}
                                            </md-button>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 col-sm-6">
                                            <ul class="list-group">
                                                <li class="list-group-item" ng-repeat="category in categories | orderBy: ['gender', 'classification', '-age'] track by category.id">
                                                    <span class="badge">{{ '{{ category.preliminary_groups }}' }}</span>
                                                    <span ng-click="selectCategory(category.id)" ng-class="{'bold': category.id==selectedCategory}">
                                                        {% trans from 'tournament' %}CATEGORY{% endtrans %} {{ '{{ category.name }}' }} - {{ '{{ category.classification_translated }}' }}
                                                    </span>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="col-md-8 col-sm-6">
                                            <div ng-show="selectedCategory && dataReady">
                                                <h3>{% trans %}FORM.QMATCHPLANNING.GROUPS{% endtrans %}</h3>
                                                <p>{% trans %}FORM.QMATCHPLANNING.EXPLAIN{% endtrans %}</p>
                                                <hr />
                                                <div class="row">
                                                    {# Show group cards #}
                                                    <div class="col-md-6" ng-repeat="group in groups track by group.group.id" ng-drop="true" ng-drop-success="onDropGroup(group.group.id)">
                                                        <h4>
                                                            <span class="label label-primary">{% trans from "tournament" %}GROUP{% endtrans %} {{ '{{ group.group.name }}' }}</span>
                                                            &nbsp;<span class="fa fa-trash" ng-hide="group.teams.length" ng-click="deleteGroup(group.group.id)"></span>
                                                        </h4>
                                                        <div class="row"
                                                             data-allow-transform="true"
                                                             ng-drag="true" ng-drag-data="team" ng-drag-success="onDragTeam(group.group.id, team.id)"
                                                             ng-repeat="team in group.teams track by team.id"
                                                        >
                                                            <div class="col-md-12">
                                                                <img src="{{ '{{ flagsDir+team.flag }}' }}"
                                                                     alt="{{ '{{ team.country }}' }}"
                                                                     title="{{ '{{ team.country }}' }}" ng-if="team.flag" class="flag">
                                                                {{ '{{ team.name }}' }}
                                                            </div>
                                                        </div>
                                                        <h4 ng-hide="group.teams.length">
                                                            <span class="badge">{% trans %}FORM.MATCHPLANNING.NOTEAMS{% endtrans %}</span>
                                                        </h4>
                                                    </div>
                                                    {# Show unassigned teams card #}
                                                    <div class="col-md-6" ng-drop="true" ng-drop-success="onDropUnassigned()">
                                                        <h4>
                                                            <span class="label label-primary">{{ 'FORM.LISTGROUPS.UNASSIGNED'|trans|upper }}</span>
                                                        </h4>
                                                        <div class="row"
                                                             data-allow-transform="true"
                                                             ng-drag="true" ng-drag-data="team" ng-drag-success="onDragUnassignedTeam(team.id)"
                                                             ng-repeat="team in unassigned.teams track by team.id"
                                                        >
                                                            <div class="col-md-12">
                                                                <img src="{{ '{{ flagsDir+team.flag }}' }}"
                                                                     alt="{{ '{{ team.country }}' }}"
                                                                     title="{{ '{{ team.country }}' }}" ng-if="team.flag" class="flag">
                                                                {{ '{{ team.name }}' }}
                                                            </div>
                                                        </div>
                                                        <h4 ng-hide="unassigned.teams.length">
                                                            <span class="badge">{% trans %}FORM.MATCHPLANNING.NOTEAMS{% endtrans %}</span>
                                                        </h4>
                                                    </div>
                                                    {# Basket card #}
                                                    <div class="col-md-6" ng-drop="true" ng-drop-success="onDropBasket()">
                                                        <span class="fa-stack fa-2x">
                                                          <i class="fa fa-trash fa-stack-1x"></i>
                                                          <i class="fa fa-ban fa-stack-2x text-danger" ng-show="group"></i>
                                                        </span>
                                                    </div>
                                                </div>
                                                <hr />
                                                <h4 ng-hide="groups.length">{% trans %}FORM.QMATCHPLANNING.NOGROUPS{% endtrans %}</h4>
                                            </div>
                                            <div ng-show="categories.length>0 && !selectedCategory && dataReady">
                                                <h3><span class="fa fa-hand-o-left"></span>&nbsp;{% trans %}FORM.QMATCHPLANNING.SELECTCATEGORY.TITLE{% endtrans %}</h3>
                                                <p>{% trans %}FORM.QMATCHPLANNING.SELECTCATEGORY.TEXT{% endtrans %}</p>
                                            </div>
                                            <div ng-show="!dataReady" style="padding: 40px;">
                                                <div layout="row" layout-sm="column" layout-align="space-around">
                                                    <div class="lead">{% trans %}FORM.QMATCHPLANNING.WAIT.TEXT{% endtrans %}</div>
                                                </div>
                                                <div layout="row" layout-sm="column" layout-align="space-around">
                                                    <md-progress-circular md-mode="indeterminate"></md-progress-circular>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </md-content>
                            </md-tab>
                            {#
                                ---------------------
                                VENUES
                                ---------------------
                            #}
                            <md-tab label="{% trans %}FORM.TOURNAMENTBOARD.LISTSITES.CAPTION{% endtrans %}">
                                <md-content class="md-padding" ng-cloak>
                                    <div class="row" ng-repeat="venue in venues | orderBy: ['no'] track by venue.id">
                                        <div class="col-sm-6">
                                            {{ '{{ venue.name }}' }}
                                        </div>
                                    </div>
                                </md-content>
                            </md-tab>
                            {#
                                ---------------------
                                ENROLLMENTS
                                ---------------------
                            #}
                            <md-tab label="{% trans %}FORM.TOURNAMENTBOARD.LISTCLUBS.CAPTION{% endtrans %}">
                                <md-content class="md-padding" ng-controller="listClubsController" ng-cloak>
                                    <div class="row">
                                        <div class="col-sm-12 md-padding">
                                            <md-button class="md-raised md-hue-1" ng-href="{{ path('_host_club_new', {'tournamentid': tournament.id }) }}">
                                                {% trans %}FORM.CLUB.TITLE.ADD{% endtrans %}
                                            </md-button>
                                            <md-button class="md-raised md-hue-1" ng-href="{{ path('_edit_import_team', {'tournamentid': tournament.id }) }}">
                                                {% trans %}FORM.TEAMIMPORT.TITLE{% endtrans %}
                                            </md-button>
                                            <md-button class="md-raised md-warn" ng-href="{{ path('_admin_wipe_teams', {'tournamentid': tournament.id }) }}">
                                                {% trans %}FORM.LISTCLUBS.BUTTON.WIPE{% endtrans %}
                                            </md-button>
                                        </div>
                                    </div>
                                    <md-tabs md-dynamic-height md-border-bottom>
                                        <md-tab label="{% trans %}FORM.LISTCLUBS.LEGEND{% endtrans %}">
                                            <md-content class="md-padding">
                                                <div class="row" ng-show="countries.length && dataReady">
                                                    {# list countries #}
                                                    <div class="col-md-6 col-lg-4" ng-repeat="country in countries">
                                                        <div class="panel panel-default">
                                                            <div class="panel-heading">
                                                                <img src="{{ '{{ flagsDir+country.flag }}' }}"
                                                                     alt="{{ '{{ country.name }}' }}"
                                                                     title="{{ '{{ country.name }}' }}" ng-if="country.flag" class="flag">
                                                                <b>{{ '{{ country.name }}' }}</b>
                                                            </div>
                                                            {# list clubs #}
                                                            <table class="table table-striped">
                                                                <tr ng-repeat="club in country.clubs">
                                                                    <td>
                                                                        <span>{{ '{{ club.name }}' }}</span>
                                                                    </td>
                                                                    <td class="narrow-col">
                                                                        <span class="label label-default" ng-show="club.enrolled" ng-click="updateEnrollment(club, $event)">{{ '{{ club.enrolled }}' }}</span>
                                                                    </td>
                                                                    <td class="narrow-col">
                                                                        <span class="fa fa-cog" aria-label="{% trans %}FORM.CLUB.TITLE.CHG{% endtrans %}" ng-click="updateClub(club, $event)">
                                                                            <md-tooltip md-direction="top" md-visible="tooltipVisible" md-autohide="false">
                                                                                {% trans %}FORM.CLUB.TITLE.CHG{% endtrans %}
                                                                            </md-tooltip>
                                                                        </span>
                                                                    </td>
                                                                </tr>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div ng-show="!countries.length && dataReady">
                                                    <h1 class="label">{{'FORM.LISTCLUBS.NOCLUB'|trans|upper}}</h1>
                                                </div>
                                            </md-content>
                                        </md-tab>
                                        <md-tab label="{% trans %}FORM.LISTCLUBS.LEGEND_TEAMS{% endtrans %}">
                                            <md-content class="md-padding">
                                                <div class="row">
                                                    <div class="col-md-6 col-lg-4" ng-repeat="category in team_categories | orderBy: ['gender', 'classification', '-age'] track by category.id">
                                                        <div class="panel panel-default">
                                                            <div class="panel-heading">
                                                                <h4>{% trans from 'tournament' %}CATEGORY{% endtrans %} {{ '{{ category.name }}' }} - {{ '{{ category.classification_translated }}' }}</h4>
                                                            </div>
                                                            {# list clubs #}
                                                            <table class="table table-striped">
                                                                <tr ng-repeat="team in category.teams | orderBy: ['index', 'country.name', 'name']">
                                                                    <td>
                                                                        <img src="{{ '{{ flagsDir+team.country.flag }}' }}"
                                                                             alt="{{ '{{ team.country.name }}' }}"
                                                                             title="{{ '{{ team.country.name }}' }}" ng-if="team.country.flag" class="flag">
                                                                        {{ '{{ team.name }}' }}
                                                                    </td>
                                                                </tr>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div ng-show="!countries.length && dataReady">
                                                    <h1 class="label">{{'FORM.LISTCLUBS.NOCLUB'|trans|upper}}</h1>
                                                </div>
                                            </md-content>
                                        </md-tab>
                                    </md-tabs>
                                </md-content>
                            </md-tab>
                            {#
                                ---------------------
                                MATCH PLANNING
                                ---------------------
                            #}
                            <md-tab label="{% trans %}FORM.TOURNAMENTBOARD.PLANNING.CAPTION{% endtrans %}">
                                <md-content class="md-padding" ng-controller="matchPlanningController" ng-cloak id="toastAnchor">
                                    <div class="row">
                                        <div class="col-sm-9 md-padding">
                                            <md-button class="md-raised md-hue-1" ng-class="{'md-primary': !matches_planned}" ng-click="planMatches($event)">
                                                {% trans %}FORM.MATCHPLANNING.PLAN.TITLE{% endtrans %}
                                            </md-button>
                                            <md-button class="md-raised md-hue-1" ng-class="{'md-primary': matches_planned}" ng-click="savePlan($event)" ng-hide="!matches_planned">
                                                {% trans %}FORM.MATCHPLANNING.SAVE.TITLE{% endtrans %}
                                            </md-button>
                                            <md-button class="md-raised md-hue-1" ng-click="resetPlan($event)" ng-hide="!matches_planned">
                                                {% trans %}FORM.MATCHPLANNING.RESET.TITLE{% endtrans %}
                                            </md-button>
                                        </div>
                                        <div class="col-sm-3 md-padding text-right">
                                            <md-button class="md-fab md-hue-1" ng-click="uploadPlan($event)">
                                                <span title="{% trans %}FORM.MATCHPLANNING.MATCHIMPORT.TITLE{% endtrans %}" class="fa fa-upload" style="font-size: 2.4em"></span>
                                            </md-button>
                                            <md-button class="md-fab md-primary" ng-href="{{ path('_edit_match_planning_download', { 'tournamentid': tournament.id }) }}" ng-hide="!matches_planned">
                                                <span title="{% trans %}FORM.MATCHPLANNING.DOWNLOAD.TITLE{% endtrans %}" class="fa fa-download" style="font-size: 2.4em"></span>
                                            </md-button>
                                        </div>
                                    </div>

                                    <div class="row" ng-show="matches_planned">
                                        <div class="col-sm-5">
                                            <md-content layout-padding>
                                                <md-card>
                                                    <md-card-title>
                                                        <md-card-title-text>
                                                            <span class="md-headline">{% trans %}FORM.TOURNAMENTBOARD.SEARCH.TITLE{% endtrans %}</span>
                                                            <span class="md-subhead">{% trans %}FORM.TOURNAMENTBOARD.SEARCH.SUBTITLE{% endtrans %}</span>
                                                        </md-card-title-text>
                                                    </md-card-title>
                                                    <form name="criteriaForm" ng-submit="search_matches(search_object)" class="md-padding" ng-cloak>
                                                        <md-input-container class="md-block">
                                                            <label>{% trans %}FORM.TOURNAMENTBOARD.TEAM{% endtrans %}</label>
                                                            <md-select name="venue" ng-model="search_object.team" ng-model-options="{trackBy: '$value.id'}">
                                                                <md-option ng-value="{ 'id': 0 }">{% trans %}FORM.TOURNAMENTBOARD.ANY{% endtrans %}</md-option>
                                                                <md-option ng-repeat="team in teams | orderBy: ['country', 'name']" ng-value="{{ '{{ team }}' }}">
                                                                    {{ '{{ team.name }}' }} ({{ '{{ team.country }}' }})
                                                                </md-option>
                                                            </md-select>
                                                        </md-input-container>
                                                        <md-input-container class="md-block">
                                                            <label>{% trans %}FORM.TOURNAMENTBOARD.CATEGORY{% endtrans %}</label>
                                                            <md-select name="category" ng-model="search_object.category" ng-model-options="{trackBy: '$value.id'}">
                                                                <md-option ng-value="{ 'id': 0 }">{% trans %}FORM.TOURNAMENTBOARD.ANY{% endtrans %}</md-option>
                                                                <md-option ng-repeat="category in categories" ng-value="{{ '{{ category }}' }}">
                                                                    {% trans from 'tournament' %}CATEGORY{% endtrans %} {{ '{{ category.name }}' }} - {{ '{{ category.classification_translated }}' }}
                                                                </md-option>
                                                            </md-select>
                                                        </md-input-container>
                                                        <md-input-container class="md-block">
                                                            <label>{% trans %}FORM.TOURNAMENTBOARD.GROUP{% endtrans %}</label>
                                                            <md-select name="group" ng-model="search_object.group" ng-model-options="{trackBy: '$value.id'}">
                                                                <md-option ng-value="{ 'id': 0 }">{% trans %}FORM.TOURNAMENTBOARD.ANY{% endtrans %}</md-option>
                                                                <md-option ng-repeat="group in groups" ng-value="{{ '{{ group }}' }}">{{ '{{ group.name }}' }}</md-option>
                                                            </md-select>
                                                        </md-input-container>
                                                        <md-input-container class="md-block">
                                                            <label>{% trans %}FORM.TOURNAMENTBOARD.PLAYGROUND{% endtrans %}</label>
                                                            <md-select name="venue" ng-model="search_object.venue" ng-model-options="{trackBy: '$value.id'}">
                                                                <md-option ng-value="{ 'id': 0 }">{% trans %}FORM.TOURNAMENTBOARD.ANY{% endtrans %}</md-option>
                                                                <md-option ng-repeat="venue in venues" ng-value="{{ '{{ venue }}' }}">{{ '{{ venue.name }}' }}</md-option>
                                                            </md-select>
                                                        </md-input-container>
                                                        <div layout="row">
                                                            <md-datepicker ng-model="search_object.date"
                                                                           md-placeholder="{% trans %}FORM.TOURNAMENTBOARD.DATE{% endtrans %}"
                                                                           md-min-date="minDate" md-max-date="maxDate">
                                                            </md-datepicker>
                                                            <span flex></span>
                                                            <md-button class="md-raised" ng-click="search_object.date=null">
                                                                {% trans %}FORM.TOURNAMENTBOARD.ANYDATE{% endtrans %}
                                                            </md-button>
                                                        </div>
                                                    </form>
                                                    <md-card-actions layout="row" layout-align="start center">
                                                        <md-input-container>
                                                            <label>{% trans %}FORM.TOURNAMENTBOARD.LIMIT{% endtrans %}</label>
                                                            <md-select name="limit" ng-model="limit" ng-model-options="{trackBy: '$value'}" required>
                                                                <md-option ng-value="10">{% trans %}FORM.TOURNAMENTBOARD.LIMIT10{% endtrans %}</md-option>
                                                                <md-option ng-value="25">{% trans %}FORM.TOURNAMENTBOARD.LIMIT25{% endtrans %}</md-option>
                                                                <md-option ng-value="100">{% trans %}FORM.TOURNAMENTBOARD.LIMIT100{% endtrans %}</md-option>
                                                                <md-option ng-value="500">{% trans %}FORM.TOURNAMENTBOARD.LIMIT500{% endtrans %}</md-option>
                                                            </md-select>
                                                        </md-input-container>
                                                    </md-card-actions>
                                                </md-card>
                                            </md-content>
                                        </div>
                                        <div class="col-sm-7">
                                            <div class="panel panel-warning" ng-show="unassigned_categories.length && matches.length==0">
                                                <div class="panel-heading">
                                                    <div class="row">
                                                        <div class="col-sm-9">
                                                            <h4>{% trans %}FORM.MATCHPLANNING.PLANNINGINCOMPLETE.TITLE{% endtrans %}</h4>
                                                            <p>{% trans %}FORM.MATCHPLANNING.PLANNINGINCOMPLETE.DESCRIPTION{% endtrans %}</p>
                                                        </div>
                                                        <div class="col-sm-3 text-center">
                                                            <span class="fa fa-exclamation-triangle fa-5x"></span>
                                                        </div>
                                                    </div>
                                                    <div class="row" ng-repeat="category in unassigned_categories | orderBy: ['gender', 'classification', '-age'] track by category.id">
                                                        <div class="col-sm-12">
                                                            <span class="badge">{{ '{{ category.unassigned_matches }}' }}</span>
                                                            <span>{% trans from 'tournament' %}CATEGORY{% endtrans %} {{ '{{ category.name }}' }} - {{ '{{ category.classification_translated }}' }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="panel panel-success" ng-show="unassigned_categories.length==0 && matches.length==0">
                                                <div class="panel-heading">
                                                    <div class="row">
                                                        <div class="col-sm-9">
                                                            <h4>{% trans %}FORM.MATCHPLANNING.PLANNINGCOMPLETE.TITLE{% endtrans %}</h4>
                                                            <p>{% trans %}FORM.MATCHPLANNING.PLANNINGCOMPLETE.DESCRIPTION{% endtrans %}</p>
                                                        </div>
                                                        <div class="col-sm-3 text-center">
                                                            <span class="fa fa-check fa-5x"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div ng-show="matches.length">
                                                <div class="row title">
                                                    <div class="col-md-1 text-center">{% trans from "tournament" %}LEGEND.NO{% endtrans %}</div>
                                                    <div class="col-md-2 text-right">
                                                        {% trans from "tournament" %}LEGEND.TIME{% endtrans %}<br />
                                                        {% trans from "tournament" %}LEGEND.PLAYGROUND{% endtrans %}
                                                    </div>
                                                    <div class="col-md-2 text-center">
                                                        {% trans from "tournament" %}LEGEND.CATEGORY{% endtrans %}<br />
                                                        {% trans from "tournament" %}LEGEND.GROUP{% endtrans %}
                                                    </div>
                                                    <div class="col-md-7">
                                                        {% trans from "tournament" %}LEGEND.HOMETEAM{% endtrans %}<br />
                                                        {% trans from "tournament" %}LEGEND.AWAYTEAM{% endtrans %}
                                                    </div>
                                                </div>
                                                <div class="row" ng-mouseenter="msover=true" ng-mouseleave="msover=false" ng-init="msover=false"
                                                     ng-class-odd="'bg-table-row'"
                                                     ng-class="{ 'bg-facebook-darkblue white': msover, 'alert-warning': match.status == 'W', 'alert-danger': match.status == 'A' }"
                                                     ng-repeat="match in matches | filter:matchFilter | limitTo:limit as results track by match.uid"
                                                     ng-click="editMatch(match, $event)"
                                                >
                                                    <div class="col-md-12 bg-facebook-lightblue facebook-blue" ng-show="$first || match.date.text != results[$index-1].date.text">
                                                        <h4><b>{% trans %}FORM.TOURNAMENTBOARD.DATE{% endtrans %} - {{ '{{ match.date.text }}' }}</b></h4>
                                                    </div>
                                                    <div class="col-md-1 text-center">{{ '{{ match.matchno }}' }}</div>
                                                    <div class="col-md-2 text-right">
                                                        {{ '{{ match.time.text }}' }}<br />
                                                        {% trans from "tournament" %}LEGEND.PLAYGROUND{% endtrans %} {{ '{{ match.venue.no }}' }}
                                                    </div>
                                                    <div class="col-md-2 text-center">
                                                        {{ '{{ match.category.name }}' }}<br />
                                                        {{ '{{ match.group.name }}' }}
                                                    </div>
                                                    <div class="col-md-7">
                                                        <img src="{{ '{{ flagsDir+match.home.flag }}' }}"
                                                             alt="{{ '{{ match.home.country }}' }}"
                                                             title="{{ '{{ match.home.country }}' }}" ng-if="match.home.flag" class="flag">
                                                        {{ '{{ match.home.name }}' }}<br />
                                                        <img src="{{ '{{ flagsDir+match.away.flag }}' }}"
                                                             alt="{{ '{{ match.away.country }}' }}"
                                                             title="{{ '{{ match.away.country }}' }}" ng-if="match.away.flag" class="flag">
                                                        {{ '{{ match.away.name }}' }}
                                                    </div>
                                                </div>
                                                <div class="md-margin md-padding" md-whiteframe="10" layout layout-align="center center" ng-if="results.length==0">
                                                    <h4 flex="80">{% trans %}FORM.TOURNAMENTBOARD.NORESULTS{% endtrans %}</h4>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    <div class="panel panel-info" ng-show="!matches_planned">
                                        <div class="panel-heading">
                                            <div class="row">
                                                <div class="col-sm-9">
                                                    <h4>{% trans %}FORM.MATCHPLANNING.NEEDTOPLAN.TITLE{% endtrans %}</h4>
                                                    <p>{% trans %}FORM.MATCHPLANNING.NEEDTOPLAN.DESCRIPTION{% endtrans %}</p>
                                                </div>
                                                <div class="col-sm-3 text-center">
                                                    <span class="fa fa-info fa-5x"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </md-content>
                            </md-tab>
                        </md-tabs>
                    </md-content>
                </md-content>
            </section>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script src="{{ url('bazinga_jstranslation_js', { 'domain': 'errors' }) }}"></script>
    <script src="{{ url('bazinga_jstranslation_js', { 'domain': 'admin' }) }}"></script>
    <script src="{{ url('bazinga_jstranslation_js', { 'domain': 'tournament' }) }}"></script>
    <script src="{{ asset('bundles/icuppublicsite/angular-bootstrap-file-field.min.js') }}"></script>
    <script>
        $("#form_file").fileinput({'showUpload':true, 'showPreview':false, 'showRemove':false, 'browseLabel':'{% trans %}FORM.MATCHPLANNING.MATCHIMPORT.BROWSE{% endtrans %}', 'uploadLabel':'{% trans %}FORM.MATCHPLANNING.MATCHIMPORT.UPLOAD{% endtrans %}'});
    </script>
    <script type="text/javascript">
        angular.module('tournamentBoardModule', ['ngMaterial', 'ngMessages', 'ngDraggable', 'bootstrap.fileField'])
                .filter("translate", function() {
                    return function(key, domain, vars){
                        return Translator.trans(key, vars ? vars : {}, domain ? domain : 'admin');
                    }
                })
                /*
                 ------------------------------------
                 TOURNAMENT BOARD
                 ------------------------------------
                 */
                .controller('tournamentBoardController', function($scope, $http, $mdDialog) {
                    $scope.flagsDir = "{{ asset('bundles/icuppublicsite/images/flags/') }}";
                    $scope.tournament = { 'id': {{ tournament.id }} };
                    $scope.categories = [];
                    $http.get(Routing.generate('_rest_list_categories', { 'tournamentid': $scope.tournament.id })).then(
                        function(data) {
                            $scope.categories = data.data;
                        },
                        function (response) {
                            ShowError($mdDialog, response.data.errors, '{% trans %}FORM.LISTCATEGORIES.CAPTION{% endtrans %}');
                        });
                    $scope.venues = [];
                    $http.get(Routing.generate('_rest_list_playgrounds', { 'tournamentid': $scope.tournament.id })).then(
                        function(data) {
                            $scope.venues = data.data;
                        },
                        function (response) {
                            ShowError($mdDialog, response.data.errors, '{% trans %}FORM.LISTSITES.CAPTION{% endtrans %}');
                        });
                    $scope.timeslots = [];
                    $http.get(Routing.generate('_rest_list_timeslots', { 'tournamentid': $scope.tournament.id })).then(
                        function(data) {
                            $scope.timeslots = data.data;
                        },
                        function (response) {
                            ShowError($mdDialog, response.data.errors, '{% trans %}FORM.LISTTIMESLOTS.CAPTION{% endtrans %}');
                        });
                })
                /*
                 ------------------------------------
                 LIST CLUBS
                 ------------------------------------
                 */
                .controller('listClubsController', function($scope, $http, $mdDialog, $mdMedia, $mdToast) {
                    $scope.updateClub = function (club, ev) {
                        $scope.club = club;
                        var dlgScope = $scope.$new();
                        dlgScope.club_object = {
                            'name': $scope.club.name,
                            'country': $scope.club.country_code
                        };
                        $mdDialog.show({
                            controller: DialogController,
                            scope: dlgScope,
                            templateUrl: '{{ asset('bundles/icuppublicsite/templates/editclubdlg.html') }}',
                            parent: angular.element(document.body),
                            targetEvent: ev,
                            clickOutsideToClose:true,
                            fullscreen: $mdMedia('sm') || $mdMedia('xs')
                        }).then(
                                function(club_object) {
                                    $http.post(Routing.generate('rest_club_update', {'clubid': $scope.club.id }), club_object).then(
                                            function (data) {
                                                $scope.club.name = club_object.name;
                                                $mdToast.show(
                                                        $mdToast.simple()
                                                                .textContent('{% trans %}FORM.CLUB.UPDATED{% endtrans %}')
                                                                .position('top right')
                                                                .hideDelay(3000)
                                                );
                                            },
                                            function (response) {
                                                ShowError($mdDialog, response.data.errors, '{% trans %}FORM.CLUB.TITLE.CHG{% endtrans %}');
                                            });
                                });
                    };
                    $scope.updateEnrollment = function (club, ev) {
                        $scope.club = club;
                        var dlgScope = $scope.$new();
                        $http.get(Routing.generate('_rest_list_enrolled_teams', { 'tournamentid': $scope.tournament.id, 'clubid': club.id })).then(
                                function(data) {
                                    dlgScope.categories = data.data;
                                });
                        $mdDialog.show({
                            controller: DialogController,
                            scope: dlgScope,
                            templateUrl: '{{ asset('bundles/icuppublicsite/templates/editenrolleddlg.html') }}',
                            parent: angular.element(document.body),
                            targetEvent: ev,
                            clickOutsideToClose:true,
                            fullscreen: $mdMedia('sm') || $mdMedia('xs')
                        });
                    };
                    $scope.addEnrollment = function (category, club) {
                        $scope.club = club;
                        $http.get(Routing.generate('_rest_club_enroll_add', { 'categoryid': category.id, 'clubid': club.id })).then(
                                function() {
                                    category.enrolled++;
                                    club.enrolled++;
                                },
                                function (response) {
                                    ShowError($mdDialog, response.data.errors, '{% trans from 'club' %}FORM.LISTENROLLED.TITLE{% endtrans %}');
                                });
                    };
                    $scope.removeEnrollment = function (category, club) {
                        $scope.club = club;
                        $http.get(Routing.generate('_rest_club_enroll_del', { 'categoryid': category.id, 'clubid': club.id })).then(
                                function() {
                                    category.enrolled--;
                                    club.enrolled--;
                                },
                                function (response) {
                                    ShowError($mdDialog, response.data.errors, '{% trans from 'club' %}FORM.LISTENROLLED.TITLE{% endtrans %}');
                                });
                    };
                    $scope.dataReady = false;
                    $scope.countries = [];
                    $http.get(Routing.generate('_rest_list_clubs', { 'tournamentid': $scope.tournament.id })).then(function(data) {
                        angular.forEach(data.data, function (club) {
                            var country = $scope.countries.find(function (country) {
                                return country.country_code == club.country_code;
                            });
                            if (country) {
                                country.clubs.push(club);
                            }
                            else {
                                $scope.countries.push({
                                    'name': club.country,
                                    'country_code': club.country_code,
                                    'flag': club.flag,
                                    'clubs': [club]
                                });
                            }
                        });
                        $scope.dataReady = true;
                    });
                    $scope.team_categories = [];
                    $http.get(Routing.generate('_rest_list_enrolled_categories', { 'tournamentid': $scope.tournament.id })).then(
                            function(data) {
                                $scope.team_categories = data.data;
                            });
                })
                /*
                 ------------------------------------
                 LIST CATEGORIES
                 ------------------------------------
                 */
                .controller('assignGroupsController', function($scope, $http, $mdDialog, $mdMedia) {
                    $scope.onDragUnassignedTeam=function(teamid){
                        var index = $scope.unassigned.teams.findIndex(function (team) {
                            return team.id == teamid;
                        });
                        var team = $scope.unassigned.teams.splice(index, 1);
                        $scope.team = team[0];
                        $scope.group = null;
                        $scope.draggingAllowed = true;
                    };
                    $scope.onDragTeam=function(groupid, teamid){
                        var group = $scope.groups.find(function (group) {
                            return group.group.id == groupid;
                        });
                        var index = group.teams.findIndex(function (team) {
                            return team.id == teamid;
                        });
                        var team = group.teams.splice(index, 1);
                        $scope.team = team[0];
                        $scope.group = group.group;
                        $scope.draggingAllowed = true;
                    };
                    $scope.onDropUnassigned=function(){
                        if ($scope.draggingAllowed) {
                            $scope.draggingAllowed = false;
                            $scope.unassigned.teams.push($scope.team);
                            if ($scope.group) {
                                $http.get(Routing.generate('_rest_assign_del', { 'groupid': $scope.group.id, 'teamid': $scope.team.id })).then(
                                    function(data) {
                                        getGroups();
                                    },
                                    function (response) {
                                        ShowError($mdDialog, response.data.errors, '{% trans %}FORM.QMATCHPLANNING.GROUPS{% endtrans %}');
                                    });
                            }
                        }
                    };
                    $scope.onDropGroup=function(groupid){
                        if ($scope.draggingAllowed) {
                            $scope.draggingAllowed = false;
                            var group = $scope.groups.find(function (group) {
                                return group.group.id == groupid;
                            });
                            group.teams.push($scope.team);
                            if ($scope.group) {
                                $http.get(Routing.generate('_rest_assign_del', { 'groupid': $scope.group.id, 'teamid': $scope.team.id })).then(
                                    function(data) {
                                        $http.get(Routing.generate('_rest_assign_add', { 'groupid': groupid, 'teamid': $scope.team.id })).then(
                                            function(data) {
                                                getGroups();
                                            },
                                            function (response) {
                                                ShowError($mdDialog, response.data.errors, '{% trans %}FORM.QMATCHPLANNING.GROUPS{% endtrans %}');
                                            });
                                },
                                function (response) {
                                    ShowError($mdDialog, response.data.errors, '{% trans %}FORM.QMATCHPLANNING.GROUPS{% endtrans %}');
                                });
                            }
                            else {
                                $http.get(Routing.generate('_rest_assign_add', { 'groupid': groupid, 'teamid': $scope.team.id })).then(
                                    function(data) {
                                        getGroups();
                                    },
                                    function (response) {
                                        ShowError($mdDialog, response.data.errors, '{% trans %}FORM.QMATCHPLANNING.GROUPS{% endtrans %}');
                                    });
                            }
                        }
                    };
                    $scope.onDropBasket=function(){
                        if ($scope.group == null) {
                            $http.get(Routing.generate('_rest_enroll_del', {'teamid': $scope.team.id})).then(
                                    function (data) {
                                        getGroups();
                                    },
                                    function (response) {
                                        ShowError($mdDialog, response.data.errors, '{% trans %}FORM.QMATCHPLANNING.GROUPS{% endtrans %}');
                                    });
                        }
                        else {
                            var group = $scope.groups.find(function (group) {
                                return group.group.id == $scope.group.id;
                            });
                            group.teams.push($scope.team);
                        }
                    };
                    $scope.addCategory = function(ev) {
                        var dlgScope = $scope.$new();
                        dlgScope.category_object = {
                            'name': '',
                            'gender': 'F',
                            'classification': 'U',
                            'age': 18,
                            'trophys': 4,
                            'topteams': 0,
                            'strategy': 2,
                            'matchtime': 60
                        };
                        $mdDialog.show({
                            controller: DialogController,
                            scope: dlgScope,
                            templateUrl: '{{ asset('bundles/icuppublicsite/templates/editcategorydlg.html') }}',
                            parent: angular.element(document.body),
                            targetEvent: ev,
                            clickOutsideToClose:true,
                            fullscreen: $mdMedia('sm') || $mdMedia('xs')
                        }).then(
                            function(category_object) {
                                $http.post(Routing.generate('rest_category_create', { 'tournamentid': $scope.tournament.id }), category_object).then(
                                        function () {

                                        },
                                        function (response) {
                                            ShowError($mdDialog, response.data.errors, '{% trans %}FORM.CATEGORY.TITLE.ADD{% endtrans %}');
                                        });
                            });
                    };
                    $scope.categoryOptions = function(ev) {
                        var dlgScope = $scope.$new();
                        dlgScope.category_object = {
                            'name': $scope.category.name,
                            'gender': $scope.category.gender,
                            'classification': $scope.category.classification,
                            'age': $scope.category.age,
                            'trophys': $scope.category.trophys,
                            'topteams': $scope.category.topteams,
                            'strategy': $scope.category.strategy,
                            'matchtime': $scope.category.matchtime
                        };
                        $mdDialog.show({
                            controller: DialogController,
                            scope: dlgScope,
                            templateUrl: '{{ asset('bundles/icuppublicsite/templates/editcatoptionsdlg.html') }}',
                            parent: angular.element(document.body),
                            targetEvent: ev,
                            clickOutsideToClose:true,
                            fullscreen: $mdMedia('sm') || $mdMedia('xs')
                        })
                        .then(function(category_object) {
                            $http.post(Routing.generate('rest_category_update', {'categoryid': $scope.selectedCategory }), category_object).then(
                                 function () {
                                    var category = $scope.categories.find(function (category) {
                                        return category.id == $scope.selectedCategory;
                                    });
                                    category.trophys = category_object.trophys;
                                    category.topteams = category_object.topteams;
                                    category.strategy = category_object.strategy;
                                 },
                                 function (response) {
                                    ShowError($mdDialog, response.data.errors, '{% trans %}FORM.QMATCHPLANNING.OPTIONS{% endtrans %}');
                                 });
                        });
                    };
                    $scope.addGroup = function(ev) {
                        var dlgScope = $scope.$new();
                        dlgScope.group_object = {
                            'name': '',
                            'classification': 0
                        };
                        $mdDialog.show({
                            controller: DialogController,
                            scope: dlgScope,
                            templateUrl: '{{ asset('bundles/icuppublicsite/templates/editgroupdlg.html') }}',
                            parent: angular.element(document.body),
                            targetEvent: ev,
                            clickOutsideToClose:true,
                            fullscreen: $mdMedia('sm') || $mdMedia('xs')
                        })
                        .then(function(group_object) {
                            $http.post(Routing.generate('rest_group_create', {'categoryid': $scope.category.id }), group_object).then(
                                function () {
                                    getGroups();
                                },
                                function (response) {
                                    ShowError($mdDialog, response.data.errors, '{% trans %}FORM.GROUP.TITLE.ADD{% endtrans %}');
                                });
                        });
                    };
                    $scope.deleteGroup = function (groupid) {
                        $http.delete(Routing.generate('rest_group_delete', {'groupid': groupid })).then(
                                function (data) {
                                    getGroups();
                                },
                                function (response) {
                                    ShowError($mdDialog, response.data.errors, '{% trans %}FORM.GROUP.TITLE.DEL{% endtrans %}');
                                });
                    };
                    $scope.assignVacant = function(groupid){
                        $http.get(Routing.generate('_rest_assign_vacant', { 'groupid': groupid })).then(
                            function(data) {
                                getGroups();
                            },
                            function (response) {
                                ShowError($mdDialog, response.data.errors, '{% trans %}FORM.QMATCHPLANNING.OPTIONS{% endtrans %}');
                            });
                    };
                    $scope.dataReady = true;
                    $scope.selectedCategory = 0;
                    $scope.selectCategory = function (id) {
                        $scope.selectedCategory = id;
                        $scope.category = $scope.categories.find(function (category) {
                            return category.id == id;
                        });
                        getGroups();
                    };
                    $scope.groups = [];
                    $scope.unassigned = [];
                    function getGroups() {
                        $scope.dataReady = false;
                        $http.get(Routing.generate('_rest_list_groups_with_teams', {'categoryid': $scope.selectedCategory })).then(
                            function (data) {
                                $scope.groups = data.data.groups;
                                $scope.unassigned = data.data.unassigned;
                                $scope.dataReady = true;
                            },
                            function (response) {
                                ShowError($mdDialog, response.data.errors, '{% trans %}FORM.QMATCHPLANNING.GROUPS{% endtrans %}');
                                $scope.groups = [];
                                $scope.unassigned = [];
                                $scope.dataReady = true;
                            });
                    };
                })
                /*
                 ------------------------------------
                 MATCH PLANNING
                 ------------------------------------
                 */
                .controller('matchPlanningController', function($scope, $http, $mdDialog, $mdMedia, $filter, $mdBottomSheet, $mdToast, $document) {
                    $scope.matches = [];
                    $scope.unassigned_categories = [];
                    $scope.matches_planned = false;
                    $scope.planning_level = -1;
                    $scope.search_object = {
                        'team': { 'id': 0 },
                        'category': { 'id': 0 },
                        'group': { 'id': 0 },
                        'venue': { 'id': 0 }
                    };
                    // limit number of matches shown
                    $scope.limit = 10;
                    $http.get(Routing.generate('_rest_get_match_calendar', { 'tournamentid': $scope.tournament.id })).then(function(data) {
                        $scope.minDate = new Date(data.data.start);
                        $scope.maxDate = new Date(data.data.end);
                    });
                    // watch the change of category and update the groups accordingly
                    $scope.$watch(
                        function () {
                            return $scope.search_object.category.id;
                        },
                        function (id, previous_id) {
                            if (id) {
                                $http.get(Routing.generate('_rest_list_groups', { 'categoryid': id })).then(
                                    function(data) {
                                        $scope.groups = data.data;
                                    },
                                    function (response) {
                                        ShowError($mdDialog, response.data.errors, '{% trans %}FORM.QMATCHPLANNING.GROUPS{% endtrans %}');
                                    });
                            }
                    });
                    $scope.matchFilter = function (match) {
                        if ($scope.search_object.team.id) {
                            if (match.home.name != $scope.search_object.team.name && match.away.name != $scope.search_object.team.name) return false;
                        }
                        if ($scope.search_object.category.id) {
                            if (match.category.id != $scope.search_object.category.id) return false;
                        }
                        if ($scope.search_object.group.id) {
                            if (match.group.id != $scope.search_object.group.id) return false;
                        }
                        if ($scope.search_object.venue.id) {
                            if (match.venue.id != $scope.search_object.venue.id) return false;
                        }
                        if ($scope.search_object.date) {
                            if (match.date.raw != $filter('date')($scope.search_object.date, 'yyyyMMdd')) return false;
                        }
                        return true;
                    };
                    GetMatchesPlanned();
                    $scope.planMatches = function (ev) {
                        var dlgScope = $scope.$new();
                        $mdDialog.show({
                            controller: DialogController,
                            scope: dlgScope,
                            templateUrl: '{{ asset('bundles/icuppublicsite/templates/planmatchdlg.html') }}',
                            parent: angular.element(document.body),
                            targetEvent: ev,
                            clickOutsideToClose:true,
                            fullscreen: $mdMedia('sm') || $mdMedia('xs')
                        })
                        .then(function() {});
                        planTournament(0, dlgScope);
                    };
                    $scope.savePlan = function () {
                        $http.get(Routing.generate('_rest_match_planning_save_plan', { 'tournamentid': $scope.tournament.id })).then(
                            function(data) {
                                $mdToast.show(
                                        $mdToast.simple()
                                                .textContent("{% trans %}FORM.MATCHPLANNING.SAVE.DONE{% endtrans %}")
                                                .position('top right')
                                                .hideDelay(5000)
                                                .parent($document[0].querySelector('#toastAnchor'))

                                );
                            },
                            function (response) {
                                ShowError($mdDialog, response.data.errors, '{% trans %}FORM.MATCHPLANNING.SAVE.TITLE{% endtrans %}');
                            });
                    };
                    $scope.resetPlan = function () {
                        $http.get(Routing.generate('_rest_match_planning_reset_plan', { 'tournamentid': $scope.tournament.id })).then(
                            function(data) {
                                $scope.unassigned_categories = [];
                                $scope.matches_planned = false;
                                $scope.planning_level = -1;
                            },
                            function (response) {
                                ShowError($mdDialog, response.data.errors, '{% trans %}FORM.MATCHPLANNING.RESET.TITLE{% endtrans %}');
                            });
                    };
                    $scope.uploadPlan = function(ev) {
                        var dlgScope = $scope.$new();
                        $mdDialog.show({
                            controller: DialogController,
                            scope: dlgScope,
                            templateUrl: '{{ asset('bundles/icuppublicsite/templates/matchimportdlg.html') }}',
                            parent: angular.element(document.body),
                            targetEvent: ev,
                            clickOutsideToClose: true,
                            fullscreen: $mdMedia('sm') || $mdMedia('xs')
                        })
                        .then(function () {
                            //create form data object
                            var r = new FileReader();
                            r.onload = function(e){
                                var fd = new FormData();
                                fd.append('file', e.target.result);
                                $http.post(Routing.generate('_rest_import_match_schedule', {'tournamentid': $scope.tournament.id}), fd, {
                                    transformRequest: angular.identity,
                                    headers: {'Content-Type': undefined}
                                }).then(
                                    function (response) {
                                        $mdToast.show(
                                            $mdToast.simple()
                                                    .textContent(Translator.trans('FORM.MATCHPLANNING.MATCHIMPORT.DONE', { 'matches': response.data.status.count, 'file': dlgScope.uploadFile.name }, 'admin'))
                                                    .position('top right')
                                                    .hideDelay(10000)
                                                    .parent($document[0].querySelector('#toastAnchor'))

                                        );
                                        GetMatchesPlanned();
                                    },
                                    function (response) {
                                        ShowError($mdDialog, response.data.errors, '{% trans %}FORM.MATCHPLANNING.MATCHIMPORT.TITLE{% endtrans %}');
                                    });
                            };
                            if (dlgScope.uploadFile.type == 'text/plain') {
                                r.readAsText(dlgScope.uploadFile);
                            }
                            else {
                                ShowError($mdDialog, ['{% trans %}FORM.MATCHPLANNING.MATCHIMPORT.INVALIDFILE{% endtrans %}'], '{% trans %}FORM.MATCHPLANNING.MATCHIMPORT.TITLE{% endtrans %}');
                            }
                        });
                    };
                    $scope.editMatch = function (match, ev) {
                        this.msover = false;
                        var dlgScope = $scope.$new();
                        dlgScope.match = match;
                        dlgScope.destination_object = { 'date': new Date(match.date.js), 'time': match.time.text, 'venue': match.venue, 'timeslot': match.timeslot };
                        dlgScope.matchFilter = function (match) {
                            if (dlgScope.destination_object.timeslot.id) {
                                if (match.timeslot.id != dlgScope.destination_object.timeslot.id) return false;
                            }
                            if (dlgScope.destination_object.venue.id) {
                                if (match.venue.id != dlgScope.destination_object.venue.id) return false;
                            }
                            if (dlgScope.destination_object.date) {
                                if (match.date.raw != $filter('date')(dlgScope.destination_object.date, 'yyyyMMdd')) return false;
                            }
                            return true;
                        };
                        $mdDialog.show({
                            controller: DialogController,
                            scope: dlgScope,
                            templateUrl: '{{ asset('bundles/icuppublicsite/templates/editplanmatchdlg.html') }}',
                            parent: angular.element(document.body),
                            targetEvent: ev,
                            clickOutsideToClose: true,
                            fullscreen: $mdMedia('sm') || $mdMedia('xs')
                        })
                        .then(function() {
                            var matchData = {
                                'timeslot': dlgScope.destination_object.timeslot.id,
                                'venue': dlgScope.destination_object.venue.id,
                                'date': $filter('date')(dlgScope.destination_object.date, 'yyyyMMdd'),
                                'matchtime': dlgScope.destination_object.time
                            };
                            $http.post(Routing.generate('_rest_match_planning_update_match', {'matchtype': dlgScope.match.uid.substr(0,1), 'matchid': dlgScope.match.uid.substr(1) }), matchData).then(
                                function (data) {
                                    $mdToast.show(
                                            $mdToast.simple()
                                                    .textContent("Match updated")
                                                    .position('top right')
                                                    .hideDelay(3000)
                                                    .parent($document[0].querySelector('#toastAnchor'))

                                    );
                                    GetMatchesPlanned();
                                    $mdToast.hide();
                                },
                                function (response) {
                                    ShowError($mdDialog, response.data.errors, '{% trans %}FORM.CLUB.TITLE.CHG{% endtrans %}');
                                });
                        });
                    };
                    function GetMatchesPlanned() {
                        $http.get(Routing.generate('_rest_match_planning_get_plan', { 'tournamentid': $scope.tournament.id })).then(
                            function(data) {
                                $scope.unassigned_categories = data.data.unassigned_by_category;
                                $scope.matches_planned = data.data.matches.length > 0;
                                $scope.matches = data.data.matches;
                                var teams = {};
                                angular.forEach($scope.matches, function (match) {
                                    if (match.uid < 'Q') {
                                        if (match.home.id) {
                                            teams[match.home.name] = match.home;
                                        }
                                        if (match.away.id) {
                                            teams[match.away.name] = match.away;
                                        }
                                    }
                                });
                                $scope.teams = [];
                                angular.forEach(teams, function (team) {
                                    $scope.teams.push(team);
                                });
                            },
                            function (response) {
                                ShowError($mdDialog, response.data.errors, '{% trans %}FORM.QMATCHPLANNING.GROUPS{% endtrans %}');
                            });
                    }
                    function planTournament(level, dlgScope) {
                        dlgScope.planning_level = level;
                        $http.get(Routing.generate('_rest_match_planning_plan', { 'tournamentid': $scope.tournament.id, 'level': level })).then(
                            function(result) {
                                if (result.data.done) {
                                    dlgScope.planning_level = result.data.level;
                                    $scope.unassigned_categories = result.data.unassigned_by_category;
                                    $scope.matches_planned = true;
                                    $scope.planning_level = result.data.level;
                                    dlgScope.planning_status = '{% trans %}FORM.MATCHPLANNING.PLANNING.DONE{% endtrans %}';
                                    GetMatchesPlanned();
                                }
                                else {
                                    planTournament(result.data.level, dlgScope);
                                }
                            },
                            function (response) {
                                ShowError($mdDialog, response.data.errors, '{% trans %}FORM.MATCHPLANNING.PLANNING.ERROR{% endtrans %}');
                            });
                    }
                });
        function DialogController($scope, $mdDialog) {
            $scope.submit = function(param) {
                $mdDialog.hide(param);
            };
            $scope.cancel = function() {
                $mdDialog.cancel();
            };
        }
        function ShowError($mdDialog, errors, title) {
            var error = Translator.trans('ERROR.'+errors.join('.')+'.TITLE', {}, 'errors');
            var solution = Translator.trans('ERROR.'+errors.join('.')+'.SOLUTION', {}, 'errors');
            $mdDialog.show($mdDialog.alert().clickOutsideToClose(true).title(error).textContent(solution).ok('{% trans %}FORM.CLOSE{% endtrans %}'));
        }
    </script>
{% endblock %}
